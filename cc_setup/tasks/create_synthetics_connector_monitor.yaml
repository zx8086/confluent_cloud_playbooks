###################################
##                               ##
## - Create Connnector Monitor - ##
##                               ##
###################################

- name: Set encrypted API key
  set_fact:
    api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33643931623166376265393533636330626334656435393936323966373036613561663233386537
          3839373331373439393265353366626563343964363262640a353234323937373738663133633132
          33616462383964383232376630373533613230336430616664626235653165336534356464356437
          6132336464313962380a636636663538326163653137356234636132386161366363373862316232
          37653763626335353962653132643830373634323735386262336134326631623636623033336631
          63646166363030363536383361613361376366363334386562313135653431363966616531643839
          633364323337373264373166336263323737

- name:  Set Connect URL
  ansible.builtin.set_fact:
    CONNECT_URL: "http://connect.dev.shared-services.eu.pvh.cloud/connectors"
    ENVIRONMENT_LONG: "development"
    PROJECT_NAME: "eu-shared-services_dev"
    api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39623531306636333664363063633031313232306165643636316562646434656664343962303335
          6662393938623464323439666361373036663232633338360a363235633239626332653835373734
          35386637383336323136626534396330303963376339663932326534336438643735306664653838
          3531396231663934340a366633663436646538363836393230643530653836353639623563356630
          31376461303531356635326563636333313636393137626439393236383361323865663433316131
          39383639363861353337316235336466653338643434323036633363393563363536333761343331
          363339616530663932646239303935613462
  when: ENVIRONMENT_SHORT == "dev"

- name: Set Connect URL
  ansible.builtin.set_fact:
    CONNECT_URL: "http://connect.stg.shared-services.eu.pvh.cloud/connectors"
    ENVIRONMENT_LONG: "staging"
    PROJECT_NAME: "eu-shared-services_stg"
    api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37616434383139633663316436353064393165616533326463316539653262386264653330623835
          6435613330326339626564316163303835336134313439350a656363386161316363386639333536
          63393238633937616635643663313566633534633837323031613830303834356362656132306538
          3633326138363537350a356338306339363130333965666331653431653564633335376439353637
          61313138306130666433333263633138616338633065646133343336656338393664353464353464
          38363639656435616233623663353033386434353639306533636634616330646263663830623637
          653631383234333533386161323939646534
  when: ENVIRONMENT_SHORT == "stg"

- name: Set Connect URL
  ansible.builtin.set_fact:
    CONNECT_URL: "http://connect.prd.shared-services.eu.pvh.cloud/connectors"
    ENVIRONMENT_LONG: "production"
    PROJECT_NAME: "eu-shared-services_prd"
    api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64303938343339623864356164343062306362613937336335303565613638643063336434663430
          3436396232383862376166386330306230646431623262660a666139303361636134666339323364
          35323861396165363032633662653636363135313436613864393266366263386563663533363063
          6662613839366436610a663163313661316663303733373931653637366437356565346334303664
          63303238366633343232623533346232613434636563643835376361316634386239353138313332
          62643834343039623930613734653934623231313134386161623339633266666534633065373232
          333034633463303637313535643238636163
  when: ENVIRONMENT_SHORT == "prd"

# - name: Set Connect URL
#   ansible.builtin.set_fact:
#     CONNECT_URL: "http://kafka-connect.beta53.kafka.marathon.dcos-eu.pvhcorp.com:8083/connectors"
#     ENVIRONMENT_LONG: "staging"
#     PROJECT_NAME: "B2B_SERVICES"
#   when: ENVIRONMENT_SHORT == "stg_dcos"

# - name: Set Connect URL
#   ansible.builtin.set_fact:
#     CONNECT_URL: "http://kafka-connect.production53.kafka.marathon.dcos-eu.pvhcorp.com:8083/connectors"
#     ENVIRONMENT_LONG: "production"
    
#   when: ENVIRONMENT_SHORT == "prd_dcos"

- name: Get Connector List via API
  block:
    - name: Get Connector List via API
      ansible.builtin.uri:
        url: "{{CONNECT_URL}}"
        method: GET
        headers:
          # Authorization: "{{ FLEET_API_TOKEN }}"
          Content-Type: application/json
        follow_redirects: safe
        force: yes
        remote_src: yes
        status_code: [200]
        return_content: yes
      delegate_to: localhost
      register: get_connector_list

    - name: Debug Variable - get_connector_list
      ansible.builtin.debug:
        var: get_connector_list
      when: debug_variables | bool

- name: Template a file to create a Synthetics Connector Monitor
  ansible.builtin.template:
    src: cc_setup/templates/CREATE_SYNTHETICS_CONNECTOR_MONITOR.j2
    dest: "./{{ PROJECT_NAME }}/lightweight/confluent/connector.{{ENVIRONMENT_SHORT}}.yml"
    # owner: bin
    # group: wheel
    mode: '0644'
  delegate_to: localhost
  delegate_facts: true
  loop: "{{get_connector_list.json}}"

- name: Deploy Lightweight Monitors to Elastic Project
  local_action: 
    module: shell
    cmd: "SYNTHETICS_API_KEY={{ api_key }} npm run push"
    chdir: "./{{ PROJECT_NAME }}"
  delegate_to: localhost
  register: deploy_project_monitors

- name: Debug Variable - deploy_project_monitors
  ansible.builtin.debug:
    var: deploy_project_monitors
  when: debug_variables | bool
